<!-- React Navbar Container -->
<div #reactNavbarContainer></div>

<main class="marketplace">
  <section class="marketplace__hero">
    <div class="marketplace__headline">
      <p class="marketplace__eyebrow">Shimmering finds. Legendary deals.</p>
      <h1 class="marketplace__title">Marketplace</h1>
      <p class="marketplace__subtitle">Trade holo-heavy favorites, chase promos, and snag grails before the next drop hits.</p>
      <div class="marketplace__actions">
        <button class="marketplace__cta">Browse drops</button>
        <button class="marketplace__ghost" type="button" (click)="openListModal()">List a card</button>
      </div>
    </div>
  </section>
  <section class="marketplace__grid" aria-label="Featured cards">
    @if (isLoading) {
    <div class="marketplace__status">Loading listings...</div>
    } @else if (loadError) {
    <div class="marketplace__status marketplace__status--error">{{ loadError }}</div>
    } @else if (listings.length === 0) {
    <div class="marketplace__status">No listings yet. Be the first to list a card.</div>
    } @else {
    @for (listing of listings; track listing.listingId) {
    <article class="card card--listing">
      <div class="card__media">
        @if (listing.imageUrl) {
        <img class="card__image" [src]="listing.imageUrl" [alt]="listing.name" loading="lazy" />
        } @else {
        <div class="card__placeholder">No image</div>
        }
      </div>
      <div class="card__frame card__frame--listing">
        <div class="card__badge">Condition {{ listing.conditionRating }}/10</div>
        <h3 class="card__name">{{ listing.name }}</h3>
        @if (listing.price) {
        <p class="card__rarity">${{ listing.price }}</p>
        }
      </div>
      <div class="card__overlay">
        <a class="card__trade" routerLink="/trade" [queryParams]="{ card: listing.name }">Make a trade</a>
      </div>
    </article>
    }
    }
  </section>
  <section class="modal" [class.modal--open]="isListModalOpen" [attr.aria-hidden]="!isListModalOpen">
    <div class="modal__backdrop" (click)="closeListModal()"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="List a card">
      <header class="modal__header">
        <div>
          <p class="modal__eyebrow">Marketplace</p>
          <h2 class="modal__title">List a card</h2>
          @if (listingSuccess) {
          <p class="modal__success">{{ listingSuccess }}</p>
          }
          @if (listingError) {
          <p class="modal__error">{{ listingError }}</p>
          }
        </div>
        <button class="modal__close" type="button" (click)="closeListModal()">Close</button>
      </header>
      <form class="modal__body">
        <label class="modal__field">
          Card name
          <input
            #cardSearchInput
            class="modal__input"
            type="text"
            [(ngModel)]="cardSearchTerm"
            (ngModelChange)="onCardSearch($event)"
            placeholder="Start typing a Pokemon name"
          />
          @if (cardSearchResults.length) {
          <div class="modal__results">
            @for (card of cardSearchResults; track card.cardId) {
            <button class="modal__result" type="button" (click)="selectCard(card)">
              <span>{{ card.name }}</span>
              <span class="modal__result-meta">#{{ card.cardId }}</span>
            </button>
            }
          </div>
          }
        </label>
        @if (selectedCard?.imageUrl) {
        <div class="modal__preview">
          <img [src]="selectedCard?.imageUrl" [alt]="selectedCard?.name" />
        </div>
        }
        <label class="modal__field">
          Condition
          <select class="modal__input" [(ngModel)]="conditionRating" name="conditionRating">
            <option [value]="10">Near Mint</option>
            <option [value]="8">Lightly Played</option>
            <option [value]="6">Moderately Played</option>
            <option [value]="4">Heavily Played</option>
          </select>
        </label>
        <label class="modal__field">
          Trade notes
          <textarea class="modal__input modal__textarea" rows="3" placeholder="What are you looking for?"></textarea>
        </label>
      </form>
      <footer class="modal__footer">
        <button class="modal__ghost" type="button" (click)="closeListModal()">Cancel</button>
        <button class="modal__cta" type="button" [disabled]="!selectedCard" (click)="submitListing()">
          Publish listing
        </button>
      </footer>
    </div>
  </section>
</main>
